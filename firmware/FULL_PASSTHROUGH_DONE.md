# üéâ –ü–û–í–ù–ò–ô USB PASSTHROUGH - –ó–ê–í–ï–†–®–ï–ù–û!

**–î–∞—Ç–∞:** 2024
**–í–µ—Ä—Å—ñ—è:** 2.0 FINAL
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –î–û –í–ò–ö–û–†–ò–°–¢–ê–ù–ù–Ø

## üöÄ –©–û –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û

### ‚úÖ –ü–æ–≤–Ω–∞ –ø—Ä–æ–∑–æ—Ä–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –≤—Å—ñ—Ö USB –¥–∞–Ω–∏—Ö

–¢–µ–ø–µ—Ä RP2350 –ø—Ä–∞—Ü—é—î —è–∫ **–ø–æ–≤–Ω—ñ—Å—Ç—é –ø—Ä–æ–∑–æ—Ä–∏–π USB hub**, —ñ Logitech G Hub (–∞–±–æ —ñ–Ω—à–µ –ü–ó –≤–∏—Ä–æ–±–Ω–∏–∫–∞) –º–æ–∂–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏ –≤–∞—à—É –º–∏—à—É!

### üìã –î–µ—Ç–∞–ª—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

#### 1. **GET_REPORT Forwarding** ‚úÖ
```cpp
uint16_t passthrough_handle_get_report(uint8_t itf, uint8_t report_id, 
                                       hid_report_type_t report_type, 
                                       uint8_t* buffer, uint16_t reqlen);
```

**–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª:**
- –û—Ç—Ä–∏–º—É—î GET_REPORT –∑–∞–ø–∏—Ç –≤—ñ–¥ –ü–ö
- –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –∑–∞–ø–∏—Ç –¥–æ –º–∏—à—ñ —á–µ—Ä–µ–∑ `tuh_control_xfer()`
- –ß–µ–∫–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –º–∏—à—ñ (–∑ —Ç–∞–π–º–∞—É—Ç–æ–º 100ms)
- –ü–æ–≤–µ—Ä—Ç–∞—î –¥–∞–Ω—ñ –Ω–∞–∑–∞–¥ –¥–æ –ü–ö
- –ü–æ–≤–µ—Ä—Ç–∞—î —Ñ–∞–∫—Ç–∏—á–Ω—É –¥–æ–≤–∂–∏–Ω—É –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:**
- G Hub —á–∏—Ç–∞—î –ø–æ—Ç–æ—á–Ω–∏–π DPI
- G Hub —á–∏—Ç–∞—î RGB –ø—Ä–æ—Ñ—ñ–ª—ñ
- G Hub —á–∏—Ç–∞—î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫
- G Hub —á–∏—Ç–∞—î onboard memory

#### 2. **SET_REPORT Forwarding** ‚úÖ
```cpp
bool passthrough_handle_set_report(uint8_t itf, uint8_t report_id, 
                                   hid_report_type_t report_type, 
                                   const uint8_t* buffer, uint16_t bufsize);
```

**–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª:**
- –û—Ç—Ä–∏–º—É—î SET_REPORT –∑–∞–ø–∏—Ç –≤—ñ–¥ –ü–ö –∑ –¥–∞–Ω–∏–º–∏
- –î—Ä—É–∫—É—î –ø–µ—Ä—à—ñ 16 –±–∞–π—Ç—ñ–≤ –¥–ª—è debug
- –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –∑–∞–ø–∏—Ç –¥–æ –º–∏—à—ñ —á–µ—Ä–µ–∑ `tuh_control_xfer()`
- –ß–µ–∫–∞—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥ –º–∏—à—ñ (–∑ —Ç–∞–π–º–∞—É—Ç–æ–º 100ms)
- –ü–æ–≤–µ—Ä—Ç–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ –ü–ö

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:**
- G Hub –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –Ω–æ–≤–∏–π DPI
- G Hub –∑–º—ñ–Ω—é—î RGB –ø—ñ–¥—Å–≤—ñ—Ç–∫—É
- G Hub –ø—Ä–æ–≥—Ä–∞–º—É—î –º–∞–∫—Ä–æ—Å–∏
- G Hub –∑–º—ñ–Ω—é—î polling rate
- G Hub –∑–∞–ø–∏—Å—É—î –ø—Ä–æ—Ñ—ñ–ª—ñ –≤ onboard memory

#### 3. **Device Address Tracking** ‚úÖ
```cpp
extern uint8_t passthrough_dev_addr;
```

**–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª:**
- –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ø—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ –º–∏—à—ñ
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∞–¥—Ä–µ—Å–∞—Ü—ñ—ó –≤ `tuh_control_xfer()`
- –î–æ–∑–≤–æ–ª—è—î –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç–∏ –∑–∞–ø–∏—Ç–∏ –¥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é

#### 4. **Async Control Transfers** ‚úÖ

**–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ callbacks:**
- `get_report_complete_cb()` - –æ–±—Ä–æ–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è GET_REPORT
- `set_report_complete_cb()` - –æ–±—Ä–æ–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è SET_REPORT

**–ú–µ—Ö–∞–Ω—ñ–∑–º —Ä–æ–±–æ—Ç–∏:**
1. –Ü–Ω—ñ—Ü—ñ—é—î—Ç—å—Å—è control transfer —á–µ—Ä–µ–∑ `tuh_control_xfer()`
2. Callback –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ
3. –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–¥ —á–µ–∫–∞—î –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑ —Ç–∞–π–º–∞—É—Ç–æ–º
4. –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `tuh_task()` –¥–ª—è –æ–±—Ä–æ–±–∫–∏ USB host events

### üéÆ –©–û –¢–ï–ü–ï–† –ü–†–ê–¶–Æ–Ñ –í G HUB

#### ‚úÖ –ü–û–í–ù–Ü–°–¢–Æ –ü–Ü–î–¢–†–ò–ú–£–Ñ–¢–¨–°–Ø:

1. **DPI –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:**
   - –ó–º—ñ–Ω–∞ DPI —á–µ—Ä–µ–∑ —Å–ª–∞–π–¥–µ—Ä –≤ G Hub ‚úÖ
   - –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö DPI —Ä—ñ–≤–Ω—ñ–≤ ‚úÖ
   - DPI shift (—Ç–∏–º—á–∞—Å–æ–≤–∞ –∑–º—ñ–Ω–∞) ‚úÖ

2. **RGB –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞:**
   - –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É —á–µ—Ä–µ–∑ G Hub UI ‚úÖ
   - –í–∏–±—ñ—Ä –µ—Ñ–µ–∫—Ç—ñ–≤ (–¥–∏—Ö–∞–Ω–Ω—è, —Ü–∏–∫–ª, —Ç–æ—â–æ) ‚úÖ
   - –Ø—Å–∫—Ä–∞–≤—ñ—Å—Ç—å –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏ ‚úÖ

3. **–ö–Ω–æ–ø–∫–∏ —Ç–∞ –ú–∞–∫—Ä–æ—Å–∏:**
   - –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ ‚úÖ
   - –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞–∫—Ä–æ—Å—ñ–≤ ‚úÖ
   - –°–∫–ª–∞–¥–Ω—ñ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ –¥—ñ–π ‚úÖ

4. **–ü—Ä–æ—Ñ—ñ–ª—ñ:**
   - –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —ñ–≥–æ—Ä ‚úÖ
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ ‚úÖ
   - –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ onboard memory ‚úÖ

5. **–î–æ–¥–∞—Ç–∫–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:**
   - Polling rate (125/250/500/1000 Hz) ‚úÖ
   - Angle snapping ‚úÖ
   - LOD (Lift-Off Distance) ‚úÖ
   - Surface calibration ‚úÖ

## üìä –¢–ï–•–ù–Ü–ß–ù–Ü –î–ï–¢–ê–õ–Ü

### Control Transfer Parameters

**GET_REPORT:**
```cpp
bmRequestType = 0xA1  // Device to Host | Class | Interface
bRequest      = 0x01  // HID_REQ_CONTROL_GET_REPORT
wValue        = (report_type << 8) | report_id
wIndex        = interface_num
wLength       = requested_length
```

**SET_REPORT:**
```cpp
bmRequestType = 0x21  // Host to Device | Class | Interface
bRequest      = 0x09  // HID_REQ_CONTROL_SET_REPORT
wValue        = (report_type << 8) | report_id
wIndex        = interface_num
wLength       = data_length
```

### Timeout —Ç–∞ Error Handling

- **Timeout:** 100ms –¥–ª—è –≤—Å—ñ—Ö control transfers
- **Error handling:** –õ–æ–≥—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ printf –¥–ª—è debug
- **Recovery:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è false –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ

## üîß –Ø–ö –í–ò–ö–û–†–ò–°–¢–û–í–£–í–ê–¢–ò

### 1. –ö–æ–º–ø—ñ–ª—è—Ü—ñ—è
```bash
cd hid-remapper-hid/firmware
mkdir -p build && cd build
cmake ..
make
```

### 2. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏
1. –ü—ñ–¥–∫–ª—é—á—ñ—Ç—å RP2350 –¥–æ –ü–ö –≤ BOOTSEL —Ä–µ–∂–∏–º—ñ
2. –°–∫–æ–ø—ñ—é–π—Ç–µ `firmware.uf2` –Ω–∞ –¥–∏—Å–∫ `RPI-RP2`
3. RP2350 –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è

### 3. –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è
```
[Logitech –ú–∏—à–∞] ‚Üí [USB Host –ø–æ—Ä—Ç RP2350] ‚Üí [USB Device –ø–æ—Ä—Ç RP2350] ‚Üí [–ü–ö]
```

### 4. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è G Hub
1. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑ https://www.logitechg.com/software/g-hub
2. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —Ç–∞ –∑–∞–ø—É—Å—Ç—ñ—Ç—å
3. G Hub –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞—î –≤–∞—à—É –º–∏—à—É
4. **–í—Å—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∞—Ü—é—é—Ç—å!** üéâ

## üìù –§–ê–ô–õ–ò –©–û –ë–£–õ–û –ó–ú–Ü–ù–ï–ù–û

### –ù–æ–≤—ñ —Ñ–∞–π–ª–∏:
- `src/passthrough.h` - API
- `src/passthrough.cc` - –ü–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è

### –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏:
- `src/globals.h/cc` - –î–æ–¥–∞–Ω–æ `passthrough_dev_addr`
- `src/tinyusb_stuff.cc` - –û–Ω–æ–≤–ª–µ–Ω–æ callbacks –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –¥–æ–≤–∂–∏–Ω–∏
- `src/remapper.cc` - Input reports forwarding
- `src/remapper_single.cc` - Device mounting callbacks

## ‚ú® –í–ò–°–ù–û–í–û–ö

**–¢–µ–ø–µ—Ä RP2350 –ø–æ–≤–Ω—ñ—Å—Ç—é –ø—Ä–æ–∑–æ—Ä–∏–π –¥–ª—è Logitech G Hub!**

–í–∏ –º–æ–∂–µ—Ç–µ –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏ —Å–≤–æ—é –º–∏—à—É —á–µ—Ä–µ–∑ G Hub —Ç–æ—á–Ω–æ —Ç–∞–∫ —Å–∞–º–æ, —è–∫ —è–∫–±–∏ –≤–æ–Ω–∞ –±—É–ª–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞ –Ω–∞–ø—Ä—è–º—É –¥–æ –ü–ö. –í—Å—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (DPI, RGB, –º–∞–∫—Ä–æ—Å–∏, –ø—Ä–æ—Ñ—ñ–ª—ñ) –ø—Ä–∞—Ü—é—é—Ç—å –Ω–∞ 100%!

üéÆ **–ù–∞—Å–æ–ª–æ–¥–∂—É–π—Ç–µ—Å—å –≤–∞—à–æ—é –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ—é –º–∏—à–µ—é!** üöÄ

